<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astronomy Dashboard</title>
    <style>
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #f4f7f6;
    color: #333;
    transition: background-color 0.4s ease, color 0.4s ease;
    line-height: 1.6;
}

body.dark-mode {
    background-color: #1a1a2e;
    color: #e0e0e0;
}

header {
    background-color: #2c3e50;
    color: #fff;
    padding: 1.5rem 1rem;
    text-align: center;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
}

h1 {
    margin: 0;
    font-size: 2.5rem;
    letter-spacing: 1px;
}

main {
    padding: 1.5rem;
    max-width: 1000px;
    margin: 0 auto;
}

section {
    background-color: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    padding: 2rem;
    transition: background-color 0.4s ease, box-shadow 0.4s ease;
}

body.dark-mode section {
    background-color: #16213e;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
}

h2 {
    color: #34495e;
    margin-top: 0;
    margin-bottom: 1.5rem;
    font-size: 1.8rem;
    border-bottom: 2px solid #e0e0e0;
    padding-bottom: 0.5rem;
}

body.dark-mode h2 {
    color: #e0e0e0;
    border-bottom-color: #334a6d;
}

h3 {
    color: #2980b9;
    font-size: 1.4rem;
    margin-top: 1rem;
    margin-bottom: 0.8rem;
}

body.dark-mode h3 {
    color: #7ddffc;
}

#apod img {
    max-width: 100%;
    height: auto;
    display: block;
    margin: 1.5rem auto;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
}

button {
    background-color: #3498db;
    color: white;
    padding: 0.8rem 1.5rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s ease, transform 0.2s ease;
    margin-right: 0.5rem;
    margin-top: 0.5rem;
}

button:hover {
    background-color: #2980b9;
    transform: translateY(-2px);
}

body.dark-mode button {
    background-color: #0f3460;
}

body.dark-mode button:hover {
    background-color: #1a527f;
}

footer {
    text-align: center;
    padding: 1.5rem;
    color: #7f8c8d;
    font-size: 0.9rem;
    background-color: #ecf0f1;
    border-top: 1px solid #e0e0e0;
}

body.dark-mode footer {
    color: #a0a0a0;
    background-color: #0f3460;
    border-top-color: #2c3e50;
}

#favoritesList.collapsed {
    display: none;
}

.favorite-item {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
    border: 1px solid #e0e0e0;
    padding: 10px;
    border-radius: 8px;
    background-color: #f9f9f9;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    transition: background-color 0.3s ease;
}

body.dark-mode .favorite-item {
    border-color: #334a6d;
    background-color: #223a5e;
}

.favorite-item:hover {
    background-color: #eef;
}

body.dark-mode .favorite-item:hover {
    background-color: #2a476e;
}

.favorite-item img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    margin-right: 15px;
    border-radius: 4px;
}

.favorite-item p {
    margin: 0;
    flex-grow: 1;
    color: #555;
}

body.dark-mode .favorite-item p {
    color: #c0c0c0;
}

.favorite-item button {
    margin-left: auto;
    padding: 0.6rem 1rem;
    font-size: 0.9rem;
    background-color: #e74c3c;
}

.favorite-item button:hover {
    background-color: #c0392b;
}

#offline-banner {
    background-color: #f39c12;
    color: #fff;
    text-align: center;
    padding: 12px;
    position: fixed;
    bottom: 0;
    width: 100%;
    display: none; /* Hidden by default */
    z-index: 1000;
    font-weight: bold;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
}

#celestial-events ul {
    list-style: none;
    padding: 0;
}

#celestial-events li {
    background-color: #ecf0f1;
    margin-bottom: 10px;
    padding: 12px 15px;
    border-radius: 8px;
    border-left: 5px solid #3498db;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

body.dark-mode #celestial-events li {
    background-color: #2c3e50;
    border-left-color: #7ddffc;
}

#celestial-events li.past-event {
    opacity: 0.6;
    border-left-color: #95a5a6;
}

#celestial-events li span {
    font-weight: bold;
    color: #2c3e50;
}

body.dark-mode #celestial-events li span {
    color: #e0e0e0;
}

#celestial-events .event-date {
    font-size: 0.9em;
    color: #7f8c8d;
}

body.dark-mode #celestial-events .event-date {
    color: #a0a0a0;
}

#neoList ul {
    list-style: none;
    padding: 0;
}

#neoList li {
    background-color: #ecf0f1;
    margin-bottom: 10px;
    padding: 12px 15px;
    border-radius: 8px;
    border-left: 5px solid #f39c12; /* A distinct color for NEOs */
    transition: background-color 0.3s ease;
}

body.dark-mode #neoList li {
    background-color: #2c3e50;
    border-left-color: #e67e22;
}

#neoList li:hover {
    background-color: #e0e6e8;
}

body.dark-mode #neoList li:hover {
    background-color: #3a506b;
}

#neoList li strong {
    color: #34495e;
}

body.dark-mode #neoList li strong {
    color: #e0e0e0;
}

#neoList li p {
    margin: 5px 0 0 0;
    font-size: 0.9em;
    color: #555;
}

body.dark-mode #neoList li p {
    color: #c0c0c0;
}

#star-chart-display {
    width: 100%;
    height: 500px; /* Increased height for better visibility */
    background-color: #000;
    color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5rem;
    border-radius: 8px;
    margin-top: 1.5rem;
    position: relative;
    overflow: hidden;
}

#star-chart-display canvas {
    width: 100% !important;
    height: 100% !important;
}

#star-chart-display img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.7;
}

#star-chart-controls {
    display: flex;
    justify-content: center;
    gap: 10px;
    margin-top: 1rem;
    flex-wrap: wrap;
}

#roverPhotosContainer, #epicImageContainer {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: center;
    margin-top: 1.5rem;
}

#roverPhotosContainer div, #epicImageContainer img {
    border: 1px solid #ccc;
    padding: 10px;
    border-radius: 8px;
    text-align: center;
    width: 180px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

body.dark-mode #roverPhotosContainer div, body.dark-mode #epicImageContainer img {
    border-color: #334a6d;
    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
}

#roverPhotosContainer img, #epicImageContainer img {
    width: 100%;
    height: 120px;
    object-fit: cover;
    border-radius: 4px;
    margin-bottom: 8px;
}

#roverPhotosContainer p {
    font-size: 0.8em;
    color: #666;
    margin: 0;
}

body.dark-mode #roverPhotosContainer p {
    color: #c0c0c0;
}

#manual-location input[type="number"] {
    padding: 0.6rem;
    margin-right: 10px;
    border: 1px solid #ccc;
    border-radius: 5px;
    font-size: 1rem;
    width: 120px;
    background-color: #f9f9f9;
    color: #333;
}

body.dark-mode #manual-location input[type="number"] {
    background-color: #2c3e50;
    border-color: #334a6d;
    color: #e0e0e0;
}

#manual-location label {
    margin-right: 5px;
    font-weight: bold;
    color: #555;
}

body.dark-mode #manual-location label {
    color: #c0c0c0;
}

#locationStatus, #manualLocationStatus {
    margin-top: 10px;
    font-style: italic;
    color: #666;
}

body.dark-mode #locationStatus, body.dark-mode #manualLocationStatus {
    color: #a0a0a0;
}

@media (max-width: 768px) {
    h1 {
        font-size: 2rem;
    }
    h2 {
        font-size: 1.6rem;
    }
    section {
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }
    button {
        padding: 0.7rem 1.2rem;
        font-size: 0.9rem;
    }
    #manual-location input[type="number"] {
        width: 100px;
        margin-bottom: 10px;
    }
    #manual-location label {
        display: block;
        margin-bottom: 5px;
    }
}

@media (max-width: 480px) {
    h1 {
        font-size: 1.8rem;
    }
    h2 {
        font-size: 1.4rem;
    }
    main {
        padding: 1rem;
    }
    section {
        padding: 1rem;
        margin-bottom: 1rem;
    }
    button {
        width: 100%;
        margin-right: 0;
    }
    #manual-location input[type="number"] {
        width: calc(100% - 22px); /* Account for padding and border */
        margin-right: 0;
    }
    #star-chart-controls button {
        width: auto;
    }
}
    </style>
</head>
<body>
    <header>
        <h1>Astronomy Dashboard</h1>
        <button id="darkModeToggle">Toggle Dark Mode</button>
    </header>
    <main>
        <section id="apod">
            <h2>Astronomy Picture of the Day</h2>
            <h3 id="apodTitle"></h3>
            <img id="apodImage" src="" alt="Astronomy Picture of the Day">
            <p id="apodDescription"></p>
            <p id="apodCopyright"></p>
        </section>
        <section id="iss-location">
            <h2>International Space Station (ISS) Location</h2>
            <p>Latitude: <span id="issLat"></span></p>
            <p>Longitude: <span id="issLon"></span></p>
        </section>
        <section id="moon-phase">
            <h2>Current Moon Phase</h2>
            <p id="moonPhaseText"></p>
        </section>
        <section id="user-location">
            <h2>Your Location</h2>
            <p>Latitude: <span id="userLat">N/A</span></p>
            <p>Longitude: <span id="userLon">N/A</span></p>
            <p id="locationStatus"></p>
        </section>
        <section id="celestial-events">
            <h2>Upcoming Celestial Events</h2>
            <ul id="eventsList">
            </ul>
        </section>

        <section id="neo-data">
            <h2>Near Earth Objects (NEOs)</h2>
            <div id="neoList">
                <p>Loading Near Earth Object data...</p>
            </div>
        </section>

        <section id="mars-rover-photos">
            <h2>Mars Rover Photos</h2>
            <div id="roverPhotosContainer">
                <p>Loading Mars Rover photos...</p>
            </div>
        </section>

        <section id="epic-images">
            <h2>Earth Polychromatic Imaging Camera (EPIC) Images</h2>
            <div id="epicImageContainer">
                <p>Loading EPIC images...</p>
            </div>
        </section>

        <section id="astronomy-fact">
            <h2>Astronomy Fact of the Day</h2>
            <p id="factTitle"></p>
            <p id="factDescription"></p>
            <button id="newFactButton">New Fact</button>
        </section>

        <section id="nasa-image-video-search">
            <h2>NASA Image and Video Library Search</h2>
            <input type="text" id="nasaSearchInput" placeholder="Search for images or videos...">
            <button id="nasaSearchButton">Search</button>
            <div id="nasaSearchResults"></div>
        </section>

        <section id="star-chart">
            <h2>Interactive Star Chart</h2>
            <div id="star-chart-display">
                <p>Star chart will appear here.</p>
            </div>
            <div id="star-chart-controls">
                <button id="refreshStarChart">Refresh Star Chart</button>
            </div>
        </section>




        
        <section id="favorites">
            <h2>Your Favorites <button id="toggleFavorites">Show/Hide</button></h2>
            <div id="favoritesList" class="collapsed">
                <p>No favorites saved yet.</p>
            </div>
        </section>
        <section id="manual-location">
            <h2>Manual Location Input</h2>
            <label for="manualLat">Latitude:</label>
            <input type="number" id="manualLat" placeholder="e.g., 34.05" step="0.01">
            <label for="manualLon">Longitude:</label>
            <input type="number" id="manualLon" placeholder="e.g., -118.25" step="0.01">
            <button id="saveLocation">Save Location</button>
            <p id="manualLocationStatus"></p>
        </section>
        </main>
    <footer>
        <p>&copy; 2025 Astronomy Dashboard</p>
    </footer>

    <div id="offline-banner">You are currently offline. Some features may be limited.</div>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-celestial@0.7.3/celestial.min.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', () => {
    const NASA_API_KEY = 'tIrqLSEdCCAzLNSihVNlIKqhiFhHW3gZIWD5cUXj';
    const APOD_URL = `https://api.nasa.gov/planetary/apod?api_key=${NASA_API_KEY}`;
    const ISS_URL = 'http://api.open-notify.org/iss-now.json';
    const CACHE_NAME = 'astronomy-dashboard-cache-v1';

    // Dark Mode Toggle
    const darkModeToggle = document.getElementById('darkModeToggle');
    // Set dark mode as default
    document.body.classList.add('dark-mode');
    localStorage.setItem('darkMode', 'enabled');

    

    darkModeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('darkMode', 'enabled');
        } else {
            localStorage.setItem('darkMode', 'disabled');
        }
    });

    // Fetch APOD with caching
    async function fetchApod() {
        const apodTitle = document.getElementById('apodTitle');
        const apodImage = document.getElementById('apodImage');
        const apodDescription = document.getElementById('apodDescription');
        const apodCopyright = document.getElementById('apodCopyright');
        const apodSection = document.getElementById('apod');

        apodTitle.textContent = 'Loading Astronomy Picture of the Day...';
        apodImage.src = '';
        apodImage.alt = '';
        apodDescription.textContent = '';
        apodCopyright.textContent = '';

        try {
            const response = await fetch(APOD_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            apodTitle.textContent = data.title;
            apodImage.src = data.hdurl || data.url;
            apodImage.alt = data.title;
            apodDescription.textContent = data.explanation;
            apodCopyright.textContent = data.copyright ? `Image Credit: ${data.copyright}` : '';

            // Cache APOD data
            const cache = await caches.open(CACHE_NAME);
            await cache.put(APOD_URL, new Response(JSON.stringify(data)));

            // Add to favorites button
            let favoriteButton = apodSection.querySelector('.favorite-button');
            if (!favoriteButton) {
                favoriteButton = document.createElement('button');
                favoriteButton.textContent = 'Add to Favorites';
                favoriteButton.classList.add('favorite-button');
                apodSection.appendChild(favoriteButton);
            }
            favoriteButton.onclick = () => {
                let favorites = JSON.parse(localStorage.getItem('apodFavorites') || '[]');
                const newFavorite = { title: data.title, url: data.url, date: data.date };
                if (!favorites.some(fav => fav.date === newFavorite.date)) {
                    favorites.push(newFavorite);
                    localStorage.setItem('apodFavorites', JSON.stringify(favorites));
                    renderFavorites();
                    alert('Added to favorites!');
                } else {
                    alert('This image is already in your favorites.');
                }
            };

            // Social Sharing Button
            let shareButton = apodSection.querySelector('.share-button');
            if (!shareButton) {
                shareButton = document.createElement('button');
                shareButton.textContent = 'Share APOD';
                shareButton.classList.add('share-button');
                apodSection.appendChild(shareButton);
            }
            shareButton.onclick = async () => {
                if (navigator.share) {
                    try {
                        await navigator.share({
                            title: data.title,
                            url: data.url,
                        });
                        console.log('APOD shared successfully');
                    } catch (error) {
                        console.error('Error sharing APOD:', error);
                    }
                } else {
                    // Fallback for browsers that do not support Web Share API
                    navigator.clipboard.writeText(data.url).then(() => {
                        alert('APOD URL copied to clipboard!');
                    }).catch(err => {
                        console.error('Could not copy text: ', err);
                    });
                }
            };

        } catch (error) {
            console.error('Error fetching APOD:', error);
            apodTitle.textContent = 'Failed to load APOD';
            apodDescription.textContent = `Error: ${error.message}. Please check your internet connection or API key.`;
            apodImage.src = ''; // Clear image on error
            apodImage.alt = 'Error loading image';

            // Try to load from cache if offline
            const cache = await caches.open(CACHE_NAME);
            const cachedResponse = await cache.match(APOD_URL);
            if (cachedResponse) {
                const data = await cachedResponse.json();
                apodTitle.textContent = `(Offline) ${data.title}`;
                apodImage.src = data.url;
                apodImage.alt = data.title;
                apodDescription.textContent = `(Offline) ${data.explanation}`;
                apodCopyright.textContent = data.copyright ? `(Offline) Image Credit: ${data.copyright}` : '';
            } else {
                apodTitle.textContent = 'Failed to load APOD';
                apodDescription.textContent = `Error: ${error.message}. No cached data available.`;
            }
        }
    }
    fetchApod();

    // Fetch ISS Location with caching
    async function fetchIssLocation() {
        const issLat = document.getElementById('issLat');
        const issLon = document.getElementById('issLon');

        issLat.textContent = 'Loading...';
        issLon.textContent = 'Loading...';

        try {
            const response = await fetch(ISS_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            issLat.textContent = data.iss_position.latitude;
            issLon.textContent = data.iss_position.longitude;

            // Cache ISS data
            const cache = await caches.open(CACHE_NAME);
            await cache.put(ISS_URL, new Response(JSON.stringify(data)));

        } catch (error) {
            console.error('Error fetching ISS location:', error);
            issLat.textContent = 'Error';
            issLon.textContent = 'Error';

            // Try to load from cache if offline
            const cache = await caches.open(CACHE_NAME);
            const cachedResponse = await cache.match(ISS_URL);
            if (cachedResponse) {
                const data = await cachedResponse.json();
                issLat.textContent = `(Offline) ${data.iss_position.latitude}`;
                issLon.textContent = `(Offline) ${data.iss_position.longitude}`;
            } else {
                issLat.textContent = 'N/A';
                issLon.textContent = 'N/A';
            }
        }
    }

    fetchIssLocation();
    setInterval(fetchIssLocation, 5000); // Update every 5 seconds

    // Moon Phase Calculation (simplified)
    function calculateMoonPhase() {
        const date = new Date();
        const year = date.getFullYear();
        const month = date.getMonth() + 1; // Month is 0-indexed
        const day = date.getDate();

        let lp = 29.530588;
        let new_moon = new Date(2000, 0, 6, 18, 30, 0); // New moon on Jan 6, 2000, 18:30 UT
        let phase = ((date.getTime() - new_moon.getTime()) / (1000 * 60 * 60 * 24)) % lp;

        let phaseText = '';
        if (phase < 1.84566) phaseText = 'New Moon';
        else if (phase < 5.53699) phaseText = 'Waxing Crescent';
        else if (phase < 9.22831) phaseText = 'First Quarter';
        else if (phase < 12.91963) phaseText = 'Waxing Gibbous';
        else if (phase < 16.61096) phaseText = 'Full Moon';
        else if (phase < 20.30228) phaseText = 'Waning Gibbous';
        else if (phase < 23.99361) phaseText = 'Last Quarter';
        else if (phase < 27.68493) phaseText = 'Waning Crescent';
        else phaseText = 'New Moon';

        document.getElementById('moonPhaseText').textContent = phaseText;
    }

    calculateMoonPhase();

    // User Location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                document.getElementById('userLat').textContent = position.coords.latitude.toFixed(2);
                document.getElementById('userLon').textContent = position.coords.longitude.toFixed(2);
                document.getElementById('locationStatus').textContent = 'Location retrieved successfully.';
                // Update manual location inputs with geo-located values
                document.getElementById('manualLat').value = position.coords.latitude.toFixed(2);
                document.getElementById('manualLon').value = position.coords.longitude.toFixed(2);
            },
            (error) => {
                document.getElementById('locationStatus').textContent = `Error getting location: ${error.message}`;
                console.error('Error getting user location:', error);
            }
        );
    } else {
        document.getElementById('locationStatus').textContent = 'Geolocation is not supported by your browser.';
    }

    // Favorites Collapsible List
    const toggleFavoritesButton = document.getElementById('toggleFavorites');
    const favoritesListDiv = document.getElementById('favoritesList');

    toggleFavoritesButton.addEventListener('click', () => {
        favoritesListDiv.classList.toggle('collapsed');
        if (favoritesListDiv.classList.contains('collapsed')) {
            toggleFavoritesButton.textContent = 'Show/Hide';
        } else {
            toggleFavoritesButton.textContent = 'Hide';
        }
    });

    // Favorites
    function renderFavorites() {
        const favorites = JSON.parse(localStorage.getItem('apodFavorites') || '[]');
        const favoritesList = document.getElementById('favoritesList');
        favoritesList.innerHTML = '';
        if (favorites.length === 0) {
            favoritesList.innerHTML = '<p>No favorites saved yet.</p>';
            return;
        }
        favorites.forEach((fav, index) => {
            const favItem = document.createElement('div');
            favItem.classList.add('favorite-item');
            favItem.innerHTML = `
                <img src="${fav.url}" alt="${fav.title}" style="width: 100px; height: 100px; object-fit: cover;">
                <p>${fav.title} (${fav.date})</p>
                <button class="delete-favorite" data-index="${index}">Delete</button>
            `;
            favoritesList.appendChild(favItem);
        });

        document.querySelectorAll('.delete-favorite').forEach(button => {
            button.onclick = (event) => {
                const indexToDelete = event.target.dataset.index;
                let favorites = JSON.parse(localStorage.getItem('apodFavorites') || '[]');
                favorites.splice(indexToDelete, 1);
                localStorage.setItem('apodFavorites', JSON.stringify(favorites));
                renderFavorites();
            };
        });
    }
    renderFavorites();

    // Manual Location Input
    const saveLocationButton = document.getElementById('saveLocation');
    saveLocationButton.addEventListener('click', () => {
        const manualLat = document.getElementById('manualLat').value;
        const manualLon = document.getElementById('manualLon').value;

        if (manualLat && manualLon) {
            localStorage.setItem('manualLat', manualLat);
            localStorage.setItem('manualLon', manualLon);
            document.getElementById('manualLocationStatus').textContent = 'Manual location saved!';
            document.getElementById('userLat').textContent = parseFloat(manualLat).toFixed(2);
            document.getElementById('userLon').textContent = parseFloat(manualLon).toFixed(2);
        } else {
            document.getElementById('manualLocationStatus').textContent = 'Please enter both latitude and longitude.';
        }
    });

    // Load manual location if available
    const savedLat = localStorage.getItem('manualLat');
    const savedLon = localStorage.getItem('manualLon');
    if (savedLat && savedLon) {
        document.getElementById('userLat').textContent = parseFloat(savedLat).toFixed(2);
        document.getElementById('userLon').textContent = parseFloat(savedLon).toFixed(2);
        document.getElementById('locationStatus').textContent = 'Using saved manual location.';
        document.getElementById('manualLat').value = savedLat;
        document.getElementById('manualLon').value = savedLon;
    }

    // Offline Mode Banner
    const offlineBanner = document.getElementById('offline-banner');

    function updateOnlineStatus() {
        if (navigator.onLine) {
            offlineBanner.style.display = 'none';
        } else {
            offlineBanner.style.display = 'block';
        }
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    updateOnlineStatus(); // Initial check

    // Celestial Events (more dynamic)
    const celestialEvents = [];

    async function fetchCelestialEvents() {
        const eventsList = document.getElementById('eventsList');
        eventsList.innerHTML = '<p>Loading celestial events...</p>';

        const today = new Date();
        const startDate = new Date();
        startDate.setDate(today.getDate() - 30); // Get events from the last 30 days

        const formattedStartDate = startDate.toISOString().split('T')[0];
        const formattedEndDate = today.toISOString().split('T')[0];

        const DONKI_API_URL_FLR = `https://api.nasa.gov/DONKI/FLR?startDate=${formattedStartDate}&endDate=${formattedEndDate}&api_key=${NASA_API_KEY}`;
        const DONKI_API_URL_CME = `https://api.nasa.gov/DONKI/CMEAnalysis?startDate=${formattedStartDate}&endDate=${formattedEndDate}&mostAccurateOnly=true&speed=500&halfAngle=30&catalog=ALL&api_key=${NASA_API_KEY}`;

        try {
            const [flrResponse, cmeResponse] = await Promise.all([
                fetch(DONKI_API_URL_FLR),
                fetch(DONKI_API_URL_CME)
            ]);

            const flrData = await flrResponse.json();
            const cmeData = await cmeResponse.json();

            let allEvents = [];

            flrData.forEach(event => {
                allEvents.push({
                    name: `Solar Flare (FLR) - Class ${event.classType}`,
                    date: event.beginTime,
                    link: event.link
                });
            });

            cmeData.forEach(event => {
                allEvents.push({
                    name: `Coronal Mass Ejection (CME) - ${event.type}`,
                    date: event.time,
                    link: event.link
                });
            });

            allEvents.sort((a, b) => new Date(a.date) - new Date(b.date));

            eventsList.innerHTML = ''; // Clear loading message

            if (allEvents.length > 0) {
                allEvents.forEach(event => {
                    const eventDate = new Date(event.date);
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <span>${event.name}</span>
                        <span class="event-date">${eventDate.toDateString()}</span>
                        ${event.link ? `<a href="${event.link}" target="_blank">Details</a>` : ''}
                    `;
                    eventsList.appendChild(listItem);
                });
            } else {
                eventsList.innerHTML = '<p>No celestial events found for the last 30 days.</p>';
            }

        } catch (error) {
            console.error('Error fetching celestial events:', error);
            eventsList.innerHTML = `<p>Failed to load celestial events: ${error.message}.</p>`;
        }
    }
    fetchCelestialEvents();

    // Near Earth Objects (NEOs)
    async function fetchNeoData() {
        const neoListDiv = document.getElementById('neoList');
        neoListDiv.innerHTML = '<p>Loading Near Earth Object data...</p>';

        const today = new Date();
        const endDate = today.toISOString().split('T')[0];
        const startDate = new Date(today);
        startDate.setDate(today.getDate() - 7); // Get NEOs for the last 7 days
        const formattedStartDate = startDate.toISOString().split('T')[0];

        const NEO_API_URL = `https://api.nasa.gov/neo/rest/v1/feed?start_date=${formattedStartDate}&end_date=${endDate}&api_key=${NASA_API_KEY}`;

        try {
            const response = await fetch(NEO_API_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            neoListDiv.innerHTML = ''; // Clear loading message

            if (data.near_earth_objects) {
                let neoHtml = '<h3>Potentially Hazardous NEOs (Last 7 Days):</h3><ul>';
                let foundNeos = false;

                for (const date in data.near_earth_objects) {
                    data.near_earth_objects[date].forEach(neo => {
                        if (neo.is_potentially_hazardous_asteroid) {
                            foundNeos = true;
                            neoHtml += `
                                <li>
                                    <strong>${neo.name}</strong><br>
                                    Approach Date: ${date}<br>
                                    Miss Distance: ${parseFloat(neo.close_approach_data[0].miss_distance.kilometers).toFixed(2)} km<br>
                                    Relative Velocity: ${parseFloat(neo.close_approach_data[0].relative_velocity.kilometers_per_second).toFixed(2)} km/s<br>
                                    Est. Diameter: ${parseFloat(neo.estimated_diameter.kilometers.estimated_diameter_min).toFixed(2)} - ${parseFloat(neo.estimated_diameter.kilometers.estimated_diameter_max).toFixed(2)} km<br>
                                    <a href="${neo.nasa_jpl_url}" target="_blank">More Info (JPL)</a>
                                </li>
                            `;
                        }
                    });
                }

                if (foundNeos) {
                    neoHtml += '</ul>';
                    neoListDiv.innerHTML = neoHtml;
                } else {
                    neoListDiv.innerHTML = '<p>No potentially hazardous NEOs detected in the last 7 days.</p>';
                }
            } else {
                neoListDiv.innerHTML = '<p>No NEO data available.</p>';
            }

        } catch (error) {
            console.error('Error fetching NEO data:', error);
            neoListDiv.innerHTML = `<p>Failed to load NEO data: ${error.message}.</p>`;
        }
    }
    fetchNeoData();

    // Mars Rover Photos
    async function fetchMarsRoverPhotos() {
        const roverPhotosContainer = document.getElementById('roverPhotosContainer');
        roverPhotosContainer.innerHTML = '<p>Loading Mars Rover photos...</p>';

        const MARS_ROVER_API_URL = `https://api.nasa.gov/mars-photos/api/v1/rovers/curiosity/latest_photos?api_key=${NASA_API_KEY}`;

        try {
            const response = await fetch(MARS_ROVER_API_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            roverPhotosContainer.innerHTML = ''; // Clear loading message

            if (data.latest_photos && data.latest_photos.length > 0) {
                let photosHtml = '<div style="display: flex; flex-wrap: wrap; gap: 15px; justify-content: center;">';
                data.latest_photos.slice(0, 10).forEach(photo => { // Limit to 10 photos
                    photosHtml += `
                        <div style="border: 1px solid #ccc; padding: 10px; border-radius: 8px; text-align: center; width: 180px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                            <img src="${photo.img_src}" alt="${photo.earth_date}" style="width: 100%; height: 120px; object-fit: cover; border-radius: 4px; margin-bottom: 8px;">
                            <p style="font-size: 0.8em; color: #666; margin: 0;">Earth Date: ${photo.earth_date}</p>
                            <p style="font-size: 0.8em; color: #666; margin: 0;">Camera: ${photo.camera.full_name}</p>
                        </div>
                    `;
                });
                photosHtml += '</div>';
                roverPhotosContainer.innerHTML = photosHtml;
            } else {
                roverPhotosContainer.innerHTML = '<p>No Mars Rover photos available.</p>';
            }

        } catch (error) {
            console.error('Error fetching Mars Rover photos:', error);
            roverPhotosContainer.innerHTML = `<p>Failed to load Mars Rover photos: ${error.message}.</p>`;
        }
    }
    fetchMarsRoverPhotos();

    // EPIC Images
    async function fetchEpicImages() {
        const epicImageContainer = document.getElementById('epicImageContainer');
        epicImageContainer.innerHTML = '<p>Loading EPIC images...</p>';

        const today = new Date();
        const year = today.getFullYear();
        const month = (today.getMonth() + 1).toString().padStart(2, '0');
        const day = today.getDate().toString().padStart(2, '0');

        const EPIC_API_URL = `https://api.nasa.gov/EPIC/api/natural/date/${year}-${month}-${day}?api_key=${NASA_API_KEY}`;

        try {
            const response = await fetch(EPIC_API_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            epicImageContainer.innerHTML = ''; // Clear loading message

            if (data && data.length > 0) {
                const latestImage = data[0]; // Get the latest image for the day
                const imageDate = new Date(latestImage.date);
                const formattedImageDate = `${imageDate.getFullYear()}/${(imageDate.getMonth() + 1).toString().padStart(2, '0')}/${imageDate.getDate().toString().padStart(2, '0')}`;
                const imageUrl = `https://api.nasa.gov/EPIC/archive/natural/${formattedImageDate}/png/${latestImage.image}.png?api_key=${NASA_API_KEY}`;

                epicImageContainer.innerHTML = `
                    <img src="${imageUrl}" alt="${latestImage.caption}" style="max-width: 100%; height: auto; display: block; margin: 1.5rem auto; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);">
                    <p>${latestImage.caption}</p>
                    <p>Date: ${latestImage.date}</p>
                `;
            } else {
                epicImageContainer.innerHTML = '<p>No EPIC images available for today.</p>';
            }

        } catch (error) {
            console.error('Error fetching EPIC images:', error);
            epicImageContainer.innerHTML = `<p>Failed to load EPIC images: ${error.message}.</p>`;
        }
    }
    fetchEpicImages();

    // Astronomical Glossary/Factoids
    const astronomyFacts = [
        {
            title: "What is a Light-Year?",
            description: "A light-year is a unit of distance, not time. It is the distance that light travels in one Earth year, which is approximately 9.46 trillion kilometers (5.88 trillion miles)."
        },
        {
            title: "The Sun's Size",
            description: "The Sun accounts for about 99.86% of the total mass of the Solar System. Approximately 1.3 million Earths could fit inside the Sun."
        },
        {
            title: "Neutron Stars",
            description: "Neutron stars are the collapsed cores of massive supergiant stars. They are incredibly dense; a sugar cube-sized amount of neutron star material would weigh about a billion tons."
        },
        {
            title: "The Observable Universe",
            description: "The observable universe is about 93 billion light-years in diameter. This is the portion of the universe that can be observed from Earth at the present time."
        },
        {
            title: "Why is Mars Red?",
            description: "Mars is known as the Red Planet because of iron minerals in the Martian soil oxidize, or rust, causing the surface and atmosphere to look red."
        }
    ];

    const factTitleElement = document.getElementById('factTitle');
    const factDescriptionElement = document.getElementById('factDescription');
    const newFactButton = document.getElementById('newFactButton');

    function displayRandomFact() {
        console.log('displayRandomFact called');
        const randomIndex = Math.floor(Math.random() * astronomyFacts.length);
        const fact = astronomyFacts[randomIndex];
        factTitleElement.textContent = fact.title;
        factDescriptionElement.textContent = fact.description;
    }

    newFactButton.addEventListener('click', () => {
        console.log('New Fact button clicked');
        displayRandomFact();
    });

    displayRandomFact(); // Display a fact on initial load

    

    

    // Star Chart Display (Placeholder - requires external API or library for actual chart rendering)
    const refreshStarChartButton = document.getElementById('refreshStarChart');
    const starChartDisplay = document.getElementById('star-chart-display');

    function updateStarChart() {
        const userLat = parseFloat(document.getElementById('userLat').textContent);
        const userLon = parseFloat(document.getElementById('userLon').textContent);

        if (isNaN(userLat) || isNaN(userLon)) {
            starChartDisplay.innerHTML = '<p>Please enable location services or enter your location manually to display the star chart.</p>';
            return;
        }

        // Clear previous chart
        starChartDisplay.innerHTML = '';

        // Initialize and display star chart using d3-celestial
        Celestial.display({
            container: "star-chart-display",
            projection: "aitoff",
            center: [userLon, userLat],
            zoomlevel: 1,
            datapath: "https://cdn.jsdelivr.net/npm/d3-celestial@0.7.3/data/",
            stars: {
                colors: true,
                names: true,
                limit: 6,
                style: { fill: "#ddf", opacity: 1 }
            },
            dsos: { show: true, names: true, limit: 6, style: { fill: "#ddf", opacity: 1 } },
            constellations: {
                show: true,
                names: true,
                fromstarnames: true,
                lines: true,
                bounds: false,
                style: { stroke: "#ccc", opacity: 0.6, width: 2 }
            },
            mw: { show: true, style: { fill: "#fff", opacity: 0.2 } },
            planets: { show: true, names: true },
            lines: {
                graticule: { show: true, stroke: "#ccc", width: 0.6, opacity: 0.8 },
                equatorial: { show: true, stroke: "#aaa", width: 1.3, opacity: 0.7 },
                ecliptic: { show: true, stroke: "#66c", width: 1.3, opacity: 0.7 },
                galactic: { show: false },
                meridian: { show: true, stroke: "#aaa", width: 1.3, opacity: 0.7 },
                zenith: { show: true, stroke: "#aaa", width: 1.3, opacity: 0.7 }
            },
            horizon: { show: true, fill: "#000000", opacity: 0.5 },
            form: false, // Hide the default form controls
            location: true // Use current location
        });
    }

    refreshStarChartButton.addEventListener('click', updateStarChart);

    // Initial call for star chart
    updateStarChart();
});
    </script>
</body>
</html>
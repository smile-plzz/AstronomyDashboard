<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Astronomy Dashboard</title>
    <style>
:root {
    --background: #f4f7f6;
    --surface: #ffffff;
    --surface-highlight: #f0f5ff;
    --text-primary: #2c3e50;
    --text-secondary: #4a6076;
    --accent: #3498db;
    --accent-strong: #1c6fb8;
    --outline: #d6dce5;
    --shadow-soft: 0 20px 45px rgba(31, 45, 61, 0.12);
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    padding: 0;
    background-color: var(--background);
    color: var(--text-secondary);
    transition: background-color 0.4s ease, color 0.4s ease;
    line-height: 1.6;
}

body.dark-mode {
    --background: #0f172a;
    --surface: #16213e;
    --surface-highlight: #1f2d4d;
    --text-primary: #f8fafc;
    --text-secondary: #cbd5f5;
    --accent: #7ddffc;
    --accent-strong: #59c5ef;
    --outline: #253355;
    --shadow-soft: 0 20px 45px rgba(5, 12, 24, 0.6);
}

header {
    background: linear-gradient(135deg, #1c2541, #0b132b);
    color: #fff;
    padding: 2.5rem 1.5rem 2rem;
    box-shadow: 0 18px 45px rgba(6, 16, 38, 0.35);
}

.header-content {
    max-width: 1100px;
    margin: 0 auto;
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
}

.header-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
}

h1 {
    margin: 0;
    font-size: 2.6rem;
    letter-spacing: 1px;
}

.header-subtitle {
    max-width: 720px;
    margin: 0;
    font-size: 1.05rem;
    line-height: 1.7;
    color: rgba(255, 255, 255, 0.85);
}

.header-actions {
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.pill {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    border-radius: 999px;
    background-color: rgba(255, 255, 255, 0.12);
    padding: 0.35rem 0.9rem;
    font-size: 0.85rem;
    color: #f8faff;
}

.header-actions button {
    width: auto;
}

main {
    padding: 2.5rem 1.5rem 4rem;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.75rem;
    max-width: 1100px;
    margin: 0 auto;
}

section.card {
    background-color: var(--surface);
    border-radius: 18px;
    box-shadow: var(--shadow-soft);
    padding: 1.75rem;
    display: flex;
    flex-direction: column;
    gap: 1rem;
    border: 1px solid var(--outline);
    transition: transform 0.3s ease, box-shadow 0.3s ease, border-color 0.3s ease;
}

section.card:hover {
    transform: translateY(-6px);
    box-shadow: 0 24px 55px rgba(25, 38, 52, 0.18);
    border-color: rgba(52, 152, 219, 0.4);
}

section.full-width {
    grid-column: 1 / -1;
}

section.highlight {
    background: linear-gradient(155deg, var(--surface), var(--surface-highlight));
}

h2 {
    color: var(--text-primary);
    margin: 0;
    font-size: 1.55rem;
    font-weight: 600;
    letter-spacing: 0.01em;
}

h3 {
    color: var(--accent);
    font-size: 1.25rem;
    margin: 0;
}

.apod-heading {
    margin-top: 0.5rem;
    color: var(--text-primary);
    font-size: 1.3rem;
}

.section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
}

.section-header h2 {
    flex: 1 1 auto;
}

.input-row {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    align-items: center;
    margin-top: 0.5rem;
}

.input-row button {
    margin-top: 0;
}

section.card p {
    margin: 0 0 0.75rem 0;
    color: var(--text-secondary);
}

section.card p:last-child {
    margin-bottom: 0;
}

#nasaSearchInput {
    padding: 0.75rem 1rem;
    border-radius: 12px;
    border: 1px solid var(--outline);
    width: min(420px, 100%);
    font-size: 1rem;
    margin-right: 0.75rem;
    background-color: var(--surface-highlight);
    color: var(--text-primary);
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

#nasaSearchInput:focus {
    outline: none;
    border-color: rgba(52, 152, 219, 0.65);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
}

#nasaSearchResults {
    margin-top: 1.5rem;
    display: grid;
    gap: 1.25rem;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
}

.search-result {
    background-color: rgba(15, 52, 96, 0.05);
    border: 1px solid rgba(52, 152, 219, 0.2);
    border-radius: 14px;
    padding: 1rem;
    display: flex;
    flex-direction: column;
    gap: 0.65rem;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.search-result:hover {
    transform: translateY(-4px);
    box-shadow: 0 18px 30px rgba(25, 38, 52, 0.16);
}

.apod-media {
    position: relative;
    width: 100%;
    border-radius: 16px;
    overflow: hidden;
    background: linear-gradient(135deg, rgba(76, 110, 245, 0.18), rgba(15, 23, 42, 0.35));
    background-size: cover;
    background-position: center;
    box-shadow: 0 14px 28px rgba(23, 31, 54, 0.22);
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 260px;
}

.apod-media.is-video {
    background: radial-gradient(circle at top, rgba(125, 223, 252, 0.18), rgba(15, 23, 42, 0.75));
}

.apod-media img,
.apod-media iframe {
    width: 100%;
    border-radius: inherit;
}

.apod-media img {
    height: auto;
    display: block;
    object-fit: cover;
}

.apod-media iframe {
    aspect-ratio: 16 / 9;
    border: 0;
    background-color: #000;
}

.apod-fallback {
    position: absolute;
    inset: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 1.75rem;
    text-align: center;
    gap: 1rem;
    background: rgba(15, 23, 42, 0.85);
    color: #e2e8f0;
}

.apod-fallback p {
    margin: 0;
    font-size: 1rem;
    line-height: 1.5;
}

.apod-fallback-actions {
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    justify-content: center;
    gap: 0.75rem;
}

.apod-fallback a {
    color: var(--accent);
    font-weight: 600;
    text-decoration: none;
    padding: 0.65rem 1.4rem;
    border-radius: 999px;
    background-color: rgba(125, 223, 252, 0.12);
    border: 1px solid rgba(125, 223, 252, 0.35);
    transition: transform 0.3s ease, box-shadow 0.3s ease, background-color 0.3s ease;
}

.apod-fallback a:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 24px rgba(125, 223, 252, 0.25);
    background-color: rgba(125, 223, 252, 0.22);
}

.apod-actions {
    display: flex;
    flex-wrap: wrap;
    gap: 0.75rem;
    margin-top: 0.5rem;
}

.apod-actions button {
    margin: 0;
}

.hidden {
    display: none !important;
}

button {
    background: linear-gradient(135deg, var(--accent), var(--accent-strong));
    color: #fff;
    padding: 0.75rem 1.55rem;
    border: none;
    border-radius: 999px;
    cursor: pointer;
    font-size: 0.95rem;
    font-weight: 600;
    letter-spacing: 0.01em;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
    margin-right: 0.5rem;
    margin-top: 0.5rem;
    box-shadow: 0 12px 25px rgba(52, 152, 219, 0.35);
}

button:hover {
    transform: translateY(-3px);
    box-shadow: 0 16px 32px rgba(52, 152, 219, 0.45);
}

button:disabled,
button:disabled:hover {
    opacity: 0.55;
    cursor: not-allowed;
    transform: none;
    box-shadow: none;
}

button.secondary {
    background: none;
    color: var(--accent);
    border: 1px solid rgba(52, 152, 219, 0.4);
    box-shadow: none;
}

button.secondary:hover {
    color: #fff;
    background: var(--accent);
    border-color: transparent;
}

footer {
    text-align: center;
    padding: 2rem 1.5rem;
    color: var(--text-secondary);
    font-size: 0.95rem;
    background-color: var(--surface);
    border-top: 1px solid var(--outline);
}

#favoritesList.collapsed {
    display: none;
}

.favorite-item {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 15px;
    border: 1px solid var(--outline);
    padding: 12px 16px;
    border-radius: 14px;
    background-color: rgba(52, 152, 219, 0.06);
    box-shadow: inset 0 0 0 1px rgba(52, 152, 219, 0.08);
    transition: background-color 0.3s ease, transform 0.3s ease;
}

.favorite-item:hover {
    transform: translateY(-2px);
    background-color: rgba(52, 152, 219, 0.12);
}

.favorite-thumbnail {
    width: 82px;
    height: 82px;
    border-radius: 12px;
    overflow: hidden;
    flex-shrink: 0;
    position: relative;
    background: linear-gradient(145deg, rgba(52, 152, 219, 0.25), rgba(76, 110, 245, 0.15));
}

.favorite-thumbnail img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
}

.favorite-media-badge {
    position: absolute;
    bottom: 6px;
    left: 6px;
    background: rgba(15, 23, 42, 0.85);
    color: #fff;
    font-size: 0.65rem;
    letter-spacing: 0.06em;
    padding: 0.15rem 0.45rem;
    border-radius: 999px;
    text-transform: uppercase;
}

.favorite-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 0.2rem;
    color: var(--text-secondary);
}

.favorite-title {
    margin: 0;
    font-weight: 600;
    color: var(--text-primary);
}

.favorite-date {
    font-size: 0.85rem;
    letter-spacing: 0.02em;
}

.favorite-item button {
    margin-left: auto;
    margin-right: 0;
    padding: 0.6rem 1rem;
    font-size: 0.9rem;
    background: linear-gradient(135deg, #f76b5c, #d63c2f);
    box-shadow: 0 12px 24px rgba(231, 76, 60, 0.35);
}

.favorite-item button:hover {
    transform: translateY(-2px);
    box-shadow: 0 16px 30px rgba(231, 76, 60, 0.45);
}

#offline-banner {
    background-color: #f39c12;
    color: #fff;
    text-align: center;
    padding: 12px;
    position: fixed;
    bottom: 0;
    width: 100%;
    display: none; /* Hidden by default */
    z-index: 1000;
    font-weight: bold;
    box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
}

#celestial-events ul {
    list-style: none;
    padding: 0;
}

#celestial-events li {
    background-color: rgba(52, 152, 219, 0.08);
    margin-bottom: 10px;
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid rgba(52, 152, 219, 0.25);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#celestial-events li.past-event {
    opacity: 0.6;
    border-color: rgba(149, 165, 166, 0.3);
}

#celestial-events li span {
    font-weight: bold;
    color: var(--text-primary);
}

#celestial-events .event-date {
    font-size: 0.9em;
    color: var(--text-secondary);
}

#neoList ul {
    list-style: none;
    padding: 0;
}

#neoList li {
    background-color: rgba(241, 196, 15, 0.12);
    margin-bottom: 10px;
    padding: 12px 15px;
    border-radius: 8px;
    border: 1px solid rgba(243, 156, 18, 0.3); /* A distinct color for NEOs */
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

#neoList li:hover {
    transform: translateY(-3px);
    box-shadow: 0 18px 32px rgba(243, 156, 18, 0.18);
}

#neoList li strong {
    color: var(--text-primary);
}

#neoList li p {
    margin: 5px 0 0 0;
    font-size: 0.9em;
    color: var(--text-secondary);
}

#star-chart-display {
    width: 100%;
    height: 500px; /* Increased height for better visibility */
    background: radial-gradient(circle at top, rgba(125, 223, 252, 0.18), rgba(12, 27, 58, 0.95));
    color: #f8fafc;
    display: flex;
    justify-content: center;
    align-items: center;
    font-size: 1.5rem;
    border-radius: 16px;
    margin-top: 1.5rem;
    position: relative;
    overflow: hidden;
    box-shadow: inset 0 0 0 1px rgba(125, 223, 252, 0.15), 0 20px 45px rgba(0, 0, 0, 0.35);
}

#star-chart-display canvas {
    width: 100% !important;
    height: 100% !important;
}

#star-chart-display img {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    object-fit: cover;
    opacity: 0.7;
}

#star-chart-controls {
    display: flex;
    justify-content: flex-start;
    gap: 12px;
    margin-top: 1.25rem;
    flex-wrap: wrap;
}

#roverPhotosContainer {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 1.25rem;
    gap: 1rem;
}

#currentRoverPhoto {
    text-align: center;
    margin-bottom: 1rem;
}

#roverImage {
    max-width: 100%;
    height: auto;
    border-radius: 12px;
    box-shadow: 0 18px 38px rgba(19, 23, 45, 0.35);
}

.rover-navigation {
    display: flex;
    gap: 12px;
}

#roverPhotoDetails {
    font-size: 0.9em;
    color: var(--text-secondary);
    margin-top: 0.5rem;
}

#epicImageContainer {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    justify-content: center;
    margin-top: 1.5rem;
}

#epicImageContainer img {
    border: 1px solid rgba(125, 223, 252, 0.25);
    padding: 12px;
    border-radius: 14px;
    text-align: center;
    width: 180px;
    box-shadow: 0 16px 30px rgba(12, 23, 54, 0.25);
}

#manual-location input[type="number"] {
    padding: 0.65rem 0.9rem;
    margin-right: 10px;
    border: 1px solid var(--outline);
    border-radius: 10px;
    font-size: 1rem;
    width: 140px;
    background-color: var(--surface-highlight);
    color: var(--text-primary);
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
}

#manual-location input[type="number"]:focus {
    outline: none;
    border-color: rgba(52, 152, 219, 0.65);
    box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
}

#manual-location label {
    margin-right: 5px;
    font-weight: 600;
    color: var(--text-primary);
}

#locationStatus, #manualLocationStatus {
    margin-top: 10px;
    font-style: italic;
    color: var(--text-secondary);
}

@media (max-width: 960px) {
    .header-top {
        flex-direction: column;
        align-items: flex-start;
    }
    .header-actions {
        width: 100%;
        justify-content: space-between;
    }
}

@media (max-width: 720px) {
    header {
        padding: 2.25rem 1.2rem 1.8rem;
    }
    h1 {
        font-size: 2.1rem;
    }
    .header-subtitle {
        font-size: 0.98rem;
    }
    main {
        padding: 2rem 1.2rem 3rem;
    }
    section.card {
        padding: 1.5rem;
    }
    button {
        width: 100%;
        margin-right: 0;
    }
    #manual-location input[type="number"] {
        width: 100%;
        margin-right: 0;
    }
    #manual-location label {
        display: block;
        margin-bottom: 5px;
    }
}

@media (max-width: 480px) {
    h1 {
        font-size: 1.85rem;
    }
    .dashboard-grid {
        gap: 1.3rem;
    }
    #star-chart-display {
        height: 360px;
    }
}
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <div class="header-top">
                <div>
                    <h1>Astronomy Dashboard</h1>
                    <p class="header-subtitle">Explore daily NASA highlights, follow spacecraft, and stay ready for the next big celestial moment with a refined command center.</p>
                </div>
                <div class="header-actions">
                    <span class="pill">Live NASA feeds</span>
                    <span class="pill">Offline aware</span>
                    <button id="darkModeToggle" class="secondary">Toggle Dark Mode</button>
                </div>
            </div>
        </div>
    </header>
    <main>
        <div class="dashboard-grid">
        <section id="apod" class="card highlight full-width">
            <h2>Astronomy Picture of the Day</h2>
            <h3 id="apodTitle" class="apod-heading"></h3>
            <div class="apod-media" id="apodMediaWrapper">
                <img id="apodImage" src="" alt="Astronomy Picture of the Day" loading="lazy" decoding="async" class="hidden">
                <iframe id="apodVideo" title="Astronomy Picture of the Day video" class="hidden" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
                <div id="apodFallback" class="apod-fallback hidden" role="alert">
                    <p id="apodFallbackText">We couldn't load today's featured media.</p>
                    <div class="apod-fallback-actions">
                        <button id="retryApod" type="button" class="secondary">Retry</button>
                        <a id="apodExternalLink" href="https://apod.nasa.gov/apod/astropix.html" target="_blank" rel="noopener">Open on NASA.gov</a>
                    </div>
                </div>
            </div>
            <p id="apodDescription"></p>
            <p id="apodCopyright"></p>
            <div class="apod-actions">
                <button id="apodFavoriteButton" type="button" disabled>Add to Favorites</button>
                <button id="apodShareButton" type="button" class="secondary" disabled>Share APOD</button>
            </div>
        </section>
        <section id="iss-location" class="card">
            <h2>International Space Station (ISS) Location</h2>
            <p>Latitude: <span id="issLat"></span></p>
            <p>Longitude: <span id="issLon"></span></p>
        </section>
        <section id="moon-phase" class="card">
            <h2>Current Moon Phase</h2>
            <p id="moonPhaseText"></p>
        </section>
        <section id="user-location" class="card">
            <h2>Your Location</h2>
            <p>Latitude: <span id="userLat">N/A</span></p>
            <p>Longitude: <span id="userLon">N/A</span></p>
            <p id="locationStatus"></p>
        </section>
        <section id="celestial-events" class="card full-width">
            <h2>Upcoming Celestial Events</h2>
            <ul id="eventsList">
            </ul>
        </section>

        <section id="neo-data" class="card">
            <h2>Near Earth Objects (NEOs)</h2>
            <div id="neoList">
                <p>Loading Near Earth Object data...</p>
            </div>
        </section>

        <section id="mars-rover-photos" class="card full-width">
            <h2>Mars Rover Photos</h2>
            <div id="roverPhotosContainer">
                <div id="currentRoverPhoto">
                    <img id="roverImage" src="" alt="Mars Rover Photo">
                    <p id="roverPhotoDetails"></p>
                </div>
                <div class="rover-navigation">
                    <button id="prevRoverPhoto">Previous</button>
                    <button id="nextRoverPhoto">Next</button>
                </div>
            </div>
        </section>

        <section id="epic-images" class="card">
            <h2>Earth Polychromatic Imaging Camera (EPIC) Images</h2>
            <div id="epicImageContainer">
                <p>Loading EPIC images...</p>
            </div>
        </section>

        <section id="astronomy-fact" class="card">
            <h2>Astronomy Fact of the Day</h2>
            <p id="factTitle"></p>
            <p id="factDescription"></p>
            <button id="newFactButton">New Fact</button>
        </section>

        <section id="nasa-image-video-search" class="card full-width">
            <h2>NASA Image and Video Library Search</h2>
            <div class="input-row">
                <input type="text" id="nasaSearchInput" placeholder="Search for images or videos...">
                <button id="nasaSearchButton">Search</button>
            </div>
            <div id="nasaSearchResults"></div>
        </section>

        <section id="star-chart" class="card full-width">
            <h2>Interactive Star Chart</h2>
            <div id="star-chart-display">
                <p>Star chart will appear here.</p>
            </div>
            <div id="star-chart-controls">
                <button id="refreshStarChart">Refresh Star Chart</button>
            </div>
        </section>
        <section id="favorites" class="card">
            <div class="section-header">
                <h2>Your Favorites</h2>
                <button id="toggleFavorites" class="secondary">Show/Hide</button>
            </div>
            <div id="favoritesList" class="collapsed">
                <p>No favorites saved yet.</p>
            </div>
        </section>
        <section id="manual-location" class="card">
            <h2>Manual Location Input</h2>
            <label for="manualLat">Latitude:</label>
            <input type="number" id="manualLat" placeholder="e.g., 34.05" step="0.01">
            <label for="manualLon">Longitude:</label>
            <input type="number" id="manualLon" placeholder="e.g., -118.25" step="0.01">
            <button id="saveLocation">Save Location</button>
            <p id="manualLocationStatus"></p>
        </section>
        </div>
    </main>
    <footer>
        <p>&copy; 2025 Astronomy Dashboard</p>
    </footer>

    <div id="offline-banner">You are currently offline. Some features may be limited.</div>

    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-celestial@0.7.3/celestial.min.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', () => {
    const NASA_API_KEY = 'tIrqLSEdCCAzLNSihVNlIKqhiFhHW3gZIWD5cUXj';
    const APOD_URL = `https://api.nasa.gov/planetary/apod?thumbs=true&api_key=${NASA_API_KEY}`;
    const ISS_URL = 'http://api.open-notify.org/iss-now.json';
    const CACHE_NAME = 'astronomy-dashboard-cache-v1';
    const CACHE_SUPPORTED = 'caches' in window;
    const APOD_FALLBACK_IMAGE = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMDAgMTYwIj4KPHJlY3Qgd2lkdGg9IjIwMCIgaGVpZ2h0PSIxNjAiIHJ4PSIxNiIgZmlsbD0iIzFjMjU0MSIvPgo8Y2lyY2xlIGN4PSIxMDAiIGN5PSI4MCIgcj0iNDgiIGZpbGw9IiMzNDk4ZGIiIG9wYWNpdHk9IjAuNjUiLz4KPHRleHQgeD0iMTAwIiB5PSI5MiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZm9udC1mYW1pbHk9IidTZWdvZSBVSScsIFRhaG9tYSwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIyMCIgZmlsbD0id2hpdGUiPkFQT0Q8L3RleHQ+Cjwvc3ZnPg==';

    if (!CACHE_SUPPORTED) {
        console.info('Cache API is unavailable in this context; offline content reuse will be limited.');
    }

    // Dark Mode Toggle
    const darkModeToggle = document.getElementById('darkModeToggle');
    // Set dark mode as default
    document.body.classList.add('dark-mode');
    localStorage.setItem('darkMode', 'enabled');

    

    darkModeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        if (document.body.classList.contains('dark-mode')) {
            localStorage.setItem('darkMode', 'enabled');
        } else {
            localStorage.setItem('darkMode', 'disabled');
        }
    });

    const apodTitle = document.getElementById('apodTitle');
    const apodImage = document.getElementById('apodImage');
    const apodVideo = document.getElementById('apodVideo');
    const apodDescription = document.getElementById('apodDescription');
    const apodCopyright = document.getElementById('apodCopyright');
    const apodMediaWrapper = document.getElementById('apodMediaWrapper');
    const apodFallback = document.getElementById('apodFallback');
    const apodFallbackText = document.getElementById('apodFallbackText');
    const apodExternalLink = document.getElementById('apodExternalLink');
    const retryApodButton = document.getElementById('retryApod');
    const apodFavoriteButton = document.getElementById('apodFavoriteButton');
    const apodShareButton = document.getElementById('apodShareButton');

    let currentApodData = null;

    function resetApodMedia() {
        apodImage.classList.add('hidden');
        apodImage.removeAttribute('src');
        apodImage.alt = '';
        apodVideo.classList.add('hidden');
        apodVideo.removeAttribute('src');
        apodVideo.removeAttribute('title');
        apodMediaWrapper.classList.remove('is-video');
        apodMediaWrapper.style.backgroundImage = '';
        apodFallback.classList.add('hidden');
    }

    function showApodFallback(message, linkUrl = 'https://apod.nasa.gov/apod/astropix.html') {
        apodImage.classList.add('hidden');
        apodImage.removeAttribute('src');
        apodVideo.classList.add('hidden');
        apodVideo.removeAttribute('src');
        apodVideo.removeAttribute('title');
        apodMediaWrapper.classList.remove('is-video');
        apodMediaWrapper.style.backgroundImage = '';
        apodFallbackText.textContent = message;
        apodFallback.classList.remove('hidden');
        if (linkUrl) {
            apodExternalLink.href = linkUrl;
        }
    }

    function getEmbeddableVideoUrl(url) {
        if (!url) {
            return '';
        }
        try {
            const parsed = new URL(url);
            if (parsed.hostname.includes('youtube.com')) {
                if (parsed.pathname === '/watch') {
                    const videoId = parsed.searchParams.get('v');
                    if (videoId) {
                        const params = new URLSearchParams();
                        if (parsed.searchParams.get('list')) {
                            params.set('list', parsed.searchParams.get('list'));
                        }
                        const start = parsed.searchParams.get('start') || parsed.searchParams.get('t');
                        if (start) {
                            params.set('start', start);
                        }
                        const paramString = params.toString();
                        return `https://www.youtube.com/embed/${videoId}${paramString ? `?${paramString}` : ''}`;
                    }
                }
                if (parsed.pathname.startsWith('/embed/')) {
                    return url;
                }
            }
            if (parsed.hostname === 'youtu.be') {
                const videoId = parsed.pathname.replace('/', '');
                const paramString = parsed.search ? parsed.search : '';
                return `https://www.youtube.com/embed/${videoId}${paramString}`;
            }
            return url;
        } catch (error) {
            console.warn('Unable to parse APOD video URL:', error);
            return url;
        }
    }

    function displayApod(data, { offline = false } = {}) {
        resetApodMedia();
        currentApodData = data;

        const prefix = offline ? '(Offline) ' : '';
        const titleText = data.title || 'Astronomy Picture of the Day';
        const descriptionText = data.explanation || 'No description is available for this entry.';
        apodTitle.textContent = `${prefix}${titleText}`;
        apodDescription.textContent = offline ? `${prefix}${descriptionText}` : descriptionText;
        apodCopyright.textContent = data.copyright ? `${prefix}Image Credit: ${data.copyright}` : '';
        apodExternalLink.href = data.url || 'https://apod.nasa.gov/apod/astropix.html';

        const imageUrl = data.hdurl || data.url || data.thumbnail_url || '';
        const shareUrl = data.media_type === 'image' ? (data.hdurl || data.url) : data.url;
        const thumbnailUrl = data.media_type === 'video'
            ? (data.thumbnail_url || APOD_FALLBACK_IMAGE)
            : (data.url || data.hdurl || APOD_FALLBACK_IMAGE);

        if (data.media_type === 'video') {
            const embedUrl = getEmbeddableVideoUrl(data.url);
            if (embedUrl) {
                apodVideo.src = embedUrl;
                apodVideo.title = `${titleText} video`;
                apodVideo.classList.remove('hidden');
                apodMediaWrapper.classList.add('is-video');
                if (thumbnailUrl) {
                    apodMediaWrapper.style.backgroundImage = `url("${thumbnailUrl}")`;
                }
            } else if (thumbnailUrl) {
                apodImage.src = thumbnailUrl;
                apodImage.alt = `${titleText} video preview`;
                apodImage.classList.remove('hidden');
                apodMediaWrapper.classList.add('is-video');
            } else {
                showApodFallback("Today's APOD is a video that must be viewed on NASA.gov.", data.url || 'https://apod.nasa.gov/apod/astropix.html');
            }
        } else if (imageUrl) {
            apodImage.src = imageUrl;
            apodImage.alt = titleText;
            apodImage.classList.remove('hidden');
        } else {
            showApodFallback("We couldn't locate a displayable image for today's APOD.", data.url || 'https://apod.nasa.gov/apod/astropix.html');
        }

        const hasSharableMedia = Boolean(shareUrl);
        apodFavoriteButton.disabled = !hasSharableMedia;
        apodShareButton.disabled = !hasSharableMedia;
    }

    apodImage.addEventListener('error', () => {
        if (!apodImage.getAttribute('src')) {
            return;
        }
        const fallbackLink = currentApodData && currentApodData.url ? currentApodData.url : 'https://apod.nasa.gov/apod/astropix.html';
        showApodFallback("We couldn't display today's image. Try again soon or open it directly on NASA.gov.", fallbackLink);
    });

    retryApodButton.addEventListener('click', () => {
        retryApodButton.disabled = true;
        fetchApod().finally(() => {
            retryApodButton.disabled = false;
        });
    });

    apodFavoriteButton.addEventListener('click', () => {
        if (!currentApodData) {
            return;
        }
        const favorites = JSON.parse(localStorage.getItem('apodFavorites') || '[]');
        const mediaUrl = currentApodData.media_type === 'image'
            ? (currentApodData.hdurl || currentApodData.url)
            : currentApodData.url;
        const thumbnailUrl = currentApodData.media_type === 'video'
            ? (currentApodData.thumbnail_url || APOD_FALLBACK_IMAGE)
            : (currentApodData.url || currentApodData.hdurl || APOD_FALLBACK_IMAGE);

        const newFavorite = {
            title: currentApodData.title || 'Astronomy Picture of the Day',
            url: mediaUrl || '',
            date: currentApodData.date || new Date().toISOString().split('T')[0],
            media_type: currentApodData.media_type,
            thumbnail_url: thumbnailUrl || APOD_FALLBACK_IMAGE,
        };

        if (!favorites.some(fav => fav.date === newFavorite.date)) {
            favorites.push(newFavorite);
            localStorage.setItem('apodFavorites', JSON.stringify(favorites));
            renderFavorites();
            alert('Added to favorites!');
        } else {
            alert('This APOD is already in your favorites.');
        }
    });

    apodShareButton.addEventListener('click', async () => {
        if (!currentApodData) {
            return;
        }
        const shareUrl = currentApodData.media_type === 'image'
            ? (currentApodData.hdurl || currentApodData.url)
            : currentApodData.url;

        if (!shareUrl) {
            alert('This item cannot be shared right now.');
            return;
        }

        try {
            if (navigator.share) {
                await navigator.share({
                    title: currentApodData.title,
                    text: currentApodData.explanation || 'Astronomy Picture of the Day',
                    url: shareUrl,
                });
            } else {
                await navigator.clipboard.writeText(shareUrl);
                alert('APOD link copied to clipboard!');
            }
        } catch (error) {
            console.error('Error sharing APOD:', error);
            alert('Sharing was canceled or not available.');
        }
    });

    // Fetch APOD with caching
    async function fetchApod() {
        currentApodData = null;
        apodFavoriteButton.disabled = true;
        apodShareButton.disabled = true;
        apodTitle.textContent = 'Loading Astronomy Picture of the Day...';
        apodDescription.textContent = '';
        apodCopyright.textContent = '';
        apodExternalLink.href = 'https://apod.nasa.gov/apod/astropix.html';
        resetApodMedia();

        try {
            const response = await fetch(APOD_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            displayApod(data);

            if (CACHE_SUPPORTED) {
                const cache = await caches.open(CACHE_NAME);
                await cache.put(APOD_URL, new Response(JSON.stringify(data)));
            }
        } catch (error) {
            console.error('Error fetching APOD:', error);
            if (CACHE_SUPPORTED) {
                const cache = await caches.open(CACHE_NAME);
                const cachedResponse = await cache.match(APOD_URL);
                if (cachedResponse) {
                    const data = await cachedResponse.json();
                    displayApod(data, { offline: true });
                    return;
                }
            }

            apodTitle.textContent = 'Failed to load APOD';
            apodDescription.textContent = `Error: ${error.message}. Please check your internet connection or API key.`;
            apodCopyright.textContent = '';
            showApodFallback('We could not reach NASA right now. Try again shortly or open the gallery on NASA.gov.');
        }
    }

    fetchApod();

    // Fetch ISS Location with caching
    async function fetchIssLocation() {
        const issLat = document.getElementById('issLat');
        const issLon = document.getElementById('issLon');

        issLat.textContent = 'Loading...';
        issLon.textContent = 'Loading...';

        try {
            const response = await fetch(ISS_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();
            issLat.textContent = data.iss_position.latitude;
            issLon.textContent = data.iss_position.longitude;

            // Cache ISS data
            if (CACHE_SUPPORTED) {
                const cache = await caches.open(CACHE_NAME);
                await cache.put(ISS_URL, new Response(JSON.stringify(data)));
            }

        } catch (error) {
            console.error('Error fetching ISS location:', error);
            issLat.textContent = 'Error';
            issLon.textContent = 'Error';

            // Try to load from cache if offline
            if (CACHE_SUPPORTED) {
                const cache = await caches.open(CACHE_NAME);
                const cachedResponse = await cache.match(ISS_URL);
                if (cachedResponse) {
                    const data = await cachedResponse.json();
                    issLat.textContent = `(Offline) ${data.iss_position.latitude}`;
                    issLon.textContent = `(Offline) ${data.iss_position.longitude}`;
                    return;
                }
            }

            issLat.textContent = 'N/A';
            issLon.textContent = 'N/A';
        }
    }

    fetchIssLocation();
    setInterval(fetchIssLocation, 5000); // Update every 5 seconds

    // Moon Phase Calculation (simplified)
    function calculateMoonPhase() {
        const date = new Date();
        const year = date.getFullYear();
        const month = date.getMonth() + 1; // Month is 0-indexed
        const day = date.getDate();

        let lp = 29.530588;
        let new_moon = new Date(2000, 0, 6, 18, 30, 0); // New moon on Jan 6, 2000, 18:30 UT
        let phase = ((date.getTime() - new_moon.getTime()) / (1000 * 60 * 60 * 24)) % lp;

        let phaseText = '';
        if (phase < 1.84566) phaseText = 'New Moon';
        else if (phase < 5.53699) phaseText = 'Waxing Crescent';
        else if (phase < 9.22831) phaseText = 'First Quarter';
        else if (phase < 12.91963) phaseText = 'Waxing Gibbous';
        else if (phase < 16.61096) phaseText = 'Full Moon';
        else if (phase < 20.30228) phaseText = 'Waning Gibbous';
        else if (phase < 23.99361) phaseText = 'Last Quarter';
        else if (phase < 27.68493) phaseText = 'Waning Crescent';
        else phaseText = 'New Moon';

        document.getElementById('moonPhaseText').textContent = phaseText;
    }

    calculateMoonPhase();

    // User Location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                document.getElementById('userLat').textContent = position.coords.latitude.toFixed(2);
                document.getElementById('userLon').textContent = position.coords.longitude.toFixed(2);
                document.getElementById('locationStatus').textContent = 'Location retrieved successfully.';
                // Update manual location inputs with geo-located values
                document.getElementById('manualLat').value = position.coords.latitude.toFixed(2);
                document.getElementById('manualLon').value = position.coords.longitude.toFixed(2);
            },
            (error) => {
                document.getElementById('locationStatus').textContent = `Error getting location: ${error.message}`;
                console.error('Error getting user location:', error);
            }
        );
    } else {
        document.getElementById('locationStatus').textContent = 'Geolocation is not supported by your browser.';
    }

    // Favorites Collapsible List
    const toggleFavoritesButton = document.getElementById('toggleFavorites');
    const favoritesListDiv = document.getElementById('favoritesList');

    toggleFavoritesButton.addEventListener('click', () => {
        favoritesListDiv.classList.toggle('collapsed');
        if (favoritesListDiv.classList.contains('collapsed')) {
            toggleFavoritesButton.textContent = 'Show/Hide';
        } else {
            toggleFavoritesButton.textContent = 'Hide';
        }
    });

    // Favorites
    function renderFavorites() {
        const favorites = JSON.parse(localStorage.getItem('apodFavorites') || '[]');
        const favoritesList = document.getElementById('favoritesList');
        favoritesList.innerHTML = '';
        if (favorites.length === 0) {
            favoritesList.innerHTML = '<p>No favorites saved yet.</p>';
            return;
        }
        favorites.forEach((fav, index) => {
            const favoriteItem = document.createElement('div');
            favoriteItem.classList.add('favorite-item');

            const thumbnailWrapper = document.createElement('div');
            thumbnailWrapper.classList.add('favorite-thumbnail');

            const thumbnailImage = document.createElement('img');
            const isVideo = (fav.media_type || '').toLowerCase() === 'video';
            const thumbnailSource = fav.thumbnail_url || (!isVideo ? fav.url : '') || APOD_FALLBACK_IMAGE;
            thumbnailImage.src = thumbnailSource;
            thumbnailImage.alt = isVideo ? `${fav.title || 'APOD'} video preview` : (fav.title || 'APOD');
            thumbnailImage.loading = 'lazy';
            thumbnailImage.addEventListener('error', () => {
                thumbnailImage.src = APOD_FALLBACK_IMAGE;
            }, { once: true });
            thumbnailWrapper.appendChild(thumbnailImage);

            if (isVideo) {
                const badge = document.createElement('span');
                badge.classList.add('favorite-media-badge');
                badge.textContent = 'Video';
                thumbnailWrapper.appendChild(badge);
            }

            const favoriteInfo = document.createElement('div');
            favoriteInfo.classList.add('favorite-info');

            const favoriteTitle = document.createElement('p');
            favoriteTitle.classList.add('favorite-title');
            favoriteTitle.textContent = fav.title || 'Astronomy Picture of the Day';
            favoriteInfo.appendChild(favoriteTitle);

            if (fav.date) {
                const favoriteDate = document.createElement('span');
                favoriteDate.classList.add('favorite-date');
                favoriteDate.textContent = fav.date;
                favoriteInfo.appendChild(favoriteDate);
            }

            const deleteButton = document.createElement('button');
            deleteButton.classList.add('delete-favorite');
            deleteButton.dataset.index = index;
            deleteButton.textContent = 'Delete';
            deleteButton.addEventListener('click', () => {
                const storedFavorites = JSON.parse(localStorage.getItem('apodFavorites') || '[]');
                storedFavorites.splice(index, 1);
                localStorage.setItem('apodFavorites', JSON.stringify(storedFavorites));
                renderFavorites();
            });

            favoriteItem.appendChild(thumbnailWrapper);
            favoriteItem.appendChild(favoriteInfo);
            favoriteItem.appendChild(deleteButton);

            favoritesList.appendChild(favoriteItem);
        });
    }
    renderFavorites();

    // Manual Location Input
    const saveLocationButton = document.getElementById('saveLocation');
    saveLocationButton.addEventListener('click', () => {
        const manualLat = document.getElementById('manualLat').value;
        const manualLon = document.getElementById('manualLon').value;

        if (manualLat && manualLon) {
            localStorage.setItem('manualLat', manualLat);
            localStorage.setItem('manualLon', manualLon);
            document.getElementById('manualLocationStatus').textContent = 'Manual location saved!';
            document.getElementById('userLat').textContent = parseFloat(manualLat).toFixed(2);
            document.getElementById('userLon').textContent = parseFloat(manualLon).toFixed(2);
        } else {
            document.getElementById('manualLocationStatus').textContent = 'Please enter both latitude and longitude.';
        }
    });

    // Load manual location if available
    const savedLat = localStorage.getItem('manualLat');
    const savedLon = localStorage.getItem('manualLon');
    if (savedLat && savedLon) {
        document.getElementById('userLat').textContent = parseFloat(savedLat).toFixed(2);
        document.getElementById('userLon').textContent = parseFloat(savedLon).toFixed(2);
        document.getElementById('locationStatus').textContent = 'Using saved manual location.';
        document.getElementById('manualLat').value = savedLat;
        document.getElementById('manualLon').value = savedLon;
    }

    // Offline Mode Banner
    const offlineBanner = document.getElementById('offline-banner');

    function updateOnlineStatus() {
        if (navigator.onLine) {
            offlineBanner.style.display = 'none';
        } else {
            offlineBanner.style.display = 'block';
        }
    }

    window.addEventListener('online', updateOnlineStatus);
    window.addEventListener('offline', updateOnlineStatus);

    updateOnlineStatus(); // Initial check

    // Celestial Events (more dynamic)
    const celestialEvents = [];

    async function fetchCelestialEvents() {
        const eventsList = document.getElementById('eventsList');
        eventsList.innerHTML = '<p>Loading celestial events...</p>';

        const today = new Date();
        const startDate = new Date();
        startDate.setDate(today.getDate() - 30); // Get events from the last 30 days

        const formattedStartDate = startDate.toISOString().split('T')[0];
        const formattedEndDate = today.toISOString().split('T')[0];

        const DONKI_API_URL_FLR = `https://api.nasa.gov/DONKI/FLR?startDate=${formattedStartDate}&endDate=${formattedEndDate}&api_key=${NASA_API_KEY}`;
        const DONKI_API_URL_CME = `https://api.nasa.gov/DONKI/CMEAnalysis?startDate=${formattedStartDate}&endDate=${formattedEndDate}&mostAccurateOnly=true&speed=500&halfAngle=30&catalog=ALL&api_key=${NASA_API_KEY}`;

        try {
            const [flrResponse, cmeResponse] = await Promise.all([
                fetch(DONKI_API_URL_FLR),
                fetch(DONKI_API_URL_CME)
            ]);

            const flrData = await flrResponse.json();
            const cmeData = await cmeResponse.json();

            let allEvents = [];

            flrData.forEach(event => {
                allEvents.push({
                    name: `Solar Flare (FLR) - Class ${event.classType}`,
                    date: event.beginTime,
                    link: event.link
                });
            });

            cmeData.forEach(event => {
                allEvents.push({
                    name: `Coronal Mass Ejection (CME) - ${event.type}`,
                    date: event.time,
                    link: event.link
                });
            });

            allEvents.sort((a, b) => new Date(a.date) - new Date(b.date));

            eventsList.innerHTML = ''; // Clear loading message

            if (allEvents.length > 0) {
                allEvents.forEach(event => {
                    const eventDate = new Date(event.date);
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `
                        <span>${event.name}</span>
                        <span class="event-date">${eventDate.toDateString()}</span>
                        ${event.link ? `<a href="${event.link}" target="_blank">Details</a>` : ''}
                    `;
                    eventsList.appendChild(listItem);
                });
            } else {
                eventsList.innerHTML = '<p>No celestial events found for the last 30 days.</p>';
            }

        } catch (error) {
            console.error('Error fetching celestial events:', error);
            eventsList.innerHTML = `<p>Failed to load celestial events: ${error.message}.</p>`;
        }
    }
    fetchCelestialEvents();

    // Near Earth Objects (NEOs)
    async function fetchNeoData() {
        const neoListDiv = document.getElementById('neoList');
        neoListDiv.innerHTML = '<p>Loading Near Earth Object data...</p>';

        const today = new Date();
        const endDate = today.toISOString().split('T')[0];
        const startDate = new Date(today);
        startDate.setDate(today.getDate() - 7); // Get NEOs for the last 7 days
        const formattedStartDate = startDate.toISOString().split('T')[0];

        const NEO_API_URL = `https://api.nasa.gov/neo/rest/v1/feed?start_date=${formattedStartDate}&end_date=${endDate}&api_key=${NASA_API_KEY}`;

        try {
            const response = await fetch(NEO_API_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            neoListDiv.innerHTML = ''; // Clear loading message

            if (data.near_earth_objects) {
                let neoHtml = '<h3>Potentially Hazardous NEOs (Last 7 Days):</h3><ul>';
                let foundNeos = false;

                for (const date in data.near_earth_objects) {
                    data.near_earth_objects[date].forEach(neo => {
                        if (neo.is_potentially_hazardous_asteroid) {
                            foundNeos = true;
                            neoHtml += `
                                <li>
                                    <strong>${neo.name}</strong><br>
                                    Approach Date: ${date}<br>
                                    Miss Distance: ${parseFloat(neo.close_approach_data[0].miss_distance.kilometers).toFixed(2)} km<br>
                                    Relative Velocity: ${parseFloat(neo.close_approach_data[0].relative_velocity.kilometers_per_second).toFixed(2)} km/s<br>
                                    Est. Diameter: ${parseFloat(neo.estimated_diameter.kilometers.estimated_diameter_min).toFixed(2)} - ${parseFloat(neo.estimated_diameter.kilometers.estimated_diameter_max).toFixed(2)} km<br>
                                    <a href="${neo.nasa_jpl_url}" target="_blank">More Info (JPL)</a>
                                </li>
                            `;
                        }
                    });
                }

                if (foundNeos) {
                    neoHtml += '</ul>';
                    neoListDiv.innerHTML = neoHtml;
                } else {
                    neoListDiv.innerHTML = '<p>No potentially hazardous NEOs detected in the last 7 days.</p>';
                }
            } else {
                neoListDiv.innerHTML = '<p>No NEO data available.</p>';
            }

        } catch (error) {
            console.error('Error fetching NEO data:', error);
            neoListDiv.innerHTML = `<p>Failed to load NEO data: ${error.message}.</p>`;
        }
    }
    fetchNeoData();

    // Mars Rover Photos
    async function fetchMarsRoverPhotos() {
        const roverPhotosContainer = document.getElementById('roverPhotosContainer');
        const roverImage = document.getElementById('roverImage');
        const roverPhotoDetails = document.getElementById('roverPhotoDetails');
        const prevRoverPhotoBtn = document.getElementById('prevRoverPhoto');
        const nextRoverPhotoBtn = document.getElementById('nextRoverPhoto');

        let currentPhotoIndex = 0;
        let roverPhotos = [];

        roverPhotosContainer.innerHTML = '<p>Loading Mars Rover photos...</p>';

        const MARS_ROVER_API_URL = `https://api.nasa.gov/mars-photos/api/v1/rovers/curiosity/latest_photos?api_key=${NASA_API_KEY}`;

        try {
            const response = await fetch(MARS_ROVER_API_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            roverPhotos = data.latest_photos;

            if (roverPhotos && roverPhotos.length > 0) {
                function displayPhoto() {
                    const photo = roverPhotos[currentPhotoIndex];
                    roverImage.src = photo.img_src;
                    roverImage.alt = `Mars Rover Photo - ${photo.earth_date}`;
                    roverPhotoDetails.textContent = `Earth Date: ${photo.earth_date} | Camera: ${photo.camera.full_name}`;
                }

                prevRoverPhotoBtn.addEventListener('click', () => {
                    currentPhotoIndex = (currentPhotoIndex - 1 + roverPhotos.length) % roverPhotos.length;
                    displayPhoto();
                });

                nextRoverPhotoBtn.addEventListener('click', () => {
                    currentPhotoIndex = (currentPhotoIndex + 1) % roverPhotos.length;
                    displayPhoto();
                });

                displayPhoto(); // Display the first photo

            } else {
                roverPhotosContainer.innerHTML = '<p>No Mars Rover photos available.</p>';
            }

        } catch (error) {
            console.error('Error fetching Mars Rover photos:', error);
            roverPhotosContainer.innerHTML = `<p>Failed to load Mars Rover photos: ${error.message}.</p>`;
        }
    }
    fetchMarsRoverPhotos();

    // EPIC Images
    async function fetchEpicImages() {
        const epicImageContainer = document.getElementById('epicImageContainer');
        epicImageContainer.innerHTML = '<p>Loading EPIC images...</p>';

        const today = new Date();
        const year = today.getFullYear();
        const month = (today.getMonth() + 1).toString().padStart(2, '0');
        const day = today.getDate().toString().padStart(2, '0');

        const EPIC_API_URL = `https://api.nasa.gov/EPIC/api/natural/date/${year}-${month}-${day}?api_key=${NASA_API_KEY}`;

        try {
            const response = await fetch(EPIC_API_URL);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            const data = await response.json();

            epicImageContainer.innerHTML = ''; // Clear loading message

            if (data && data.length > 0) {
                const latestImage = data[0]; // Get the latest image for the day
                const imageDate = new Date(latestImage.date);
                const formattedImageDate = `${imageDate.getFullYear()}/${(imageDate.getMonth() + 1).toString().padStart(2, '0')}/${imageDate.getDate().toString().padStart(2, '0')}`;
                const imageUrl = `https://api.nasa.gov/EPIC/archive/natural/${formattedImageDate}/png/${latestImage.image}.png?api_key=${NASA_API_KEY}`;

                epicImageContainer.innerHTML = `
                    <img src="${imageUrl}" alt="${latestImage.caption}" style="max-width: 100%; height: auto; display: block; margin: 1.5rem auto; border-radius: 8px; box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);">
                    <p>${latestImage.caption}</p>
                    <p>Date: ${latestImage.date}</p>
                `;
            } else {
                epicImageContainer.innerHTML = '<p>No EPIC images available for today.</p>';
            }

        } catch (error) {
            console.error('Error fetching EPIC images:', error);
            epicImageContainer.innerHTML = `<p>Failed to load EPIC images: ${error.message}.</p>`;
        }
    }
    fetchEpicImages();

    // Astronomical Glossary/Factoids
    const astronomyFacts = [
        {
            title: "What is a Light-Year?",
            description: "A light-year is a unit of distance, not time. It is the distance that light travels in one Earth year, which is approximately 9.46 trillion kilometers (5.88 trillion miles)."
        },
        {
            title: "The Sun's Size",
            description: "The Sun accounts for about 99.86% of the total mass of the Solar System. Approximately 1.3 million Earths could fit inside the Sun."
        },
        {
            title: "Neutron Stars",
            description: "Neutron stars are the collapsed cores of massive supergiant stars. They are incredibly dense; a sugar cube-sized amount of neutron star material would weigh about a billion tons."
        },
        {
            title: "The Observable Universe",
            description: "The observable universe is about 93 billion light-years in diameter. This is the portion of the universe that can be observed from Earth at the present time."
        },
        {
            title: "Why is Mars Red?",
            description: "Mars is known as the Red Planet because of iron minerals in the Martian soil oxidize, or rust, causing the surface and atmosphere to look red."
        }
    ];

    const factTitleElement = document.getElementById('factTitle');
    const factDescriptionElement = document.getElementById('factDescription');
    const newFactButton = document.getElementById('newFactButton');

    function displayRandomFact() {
        console.log('displayRandomFact called');
        const randomIndex = Math.floor(Math.random() * astronomyFacts.length);
        const fact = astronomyFacts[randomIndex];
        factTitleElement.textContent = fact.title;
        factDescriptionElement.textContent = fact.description;
    }

    newFactButton.addEventListener('click', () => {
        console.log('New Fact button clicked');
        displayRandomFact();
    });

    displayRandomFact(); // Display a fact on initial load

    

    

    // Star Chart Display (Placeholder - requires external API or library for actual chart rendering)
    const refreshStarChartButton = document.getElementById('refreshStarChart');
    const starChartDisplay = document.getElementById('star-chart-display');

    function updateStarChart() {
        const userLat = parseFloat(document.getElementById('userLat').textContent);
        const userLon = parseFloat(document.getElementById('userLon').textContent);

        if (isNaN(userLat) || isNaN(userLon)) {
            starChartDisplay.innerHTML = '<p>Please enable location services or enter your location manually to display the star chart.</p>';
            return;
        }

        // Clear previous chart
        starChartDisplay.innerHTML = '';

        // Initialize and display star chart using d3-celestial
        Celestial.display({
            container: "star-chart-display",
            projection: "aitoff",
            center: [userLon, userLat],
            zoomlevel: 1,
            datapath: "https://cdn.jsdelivr.net/npm/d3-celestial@0.7.3/data/",
            stars: {
                colors: true,
                names: true,
                limit: 6,
                style: { fill: "#ddf", opacity: 1 }
            },
            dsos: { show: true, names: true, limit: 6, style: { fill: "#ddf", opacity: 1 } },
            constellations: {
                show: true,
                names: true,
                fromstarnames: true,
                lines: true,
                bounds: false,
                style: { stroke: "#ccc", opacity: 0.6, width: 2 }
            },
            mw: { show: true, style: { fill: "#fff", opacity: 0.2 } },
            planets: { show: true, names: true },
            lines: {
                graticule: { show: true, stroke: "#ccc", width: 0.6, opacity: 0.8 },
                equatorial: { show: true, stroke: "#aaa", width: 1.3, opacity: 0.7 },
                ecliptic: { show: true, stroke: "#66c", width: 1.3, opacity: 0.7 },
                galactic: { show: false },
                meridian: { show: true, stroke: "#aaa", width: 1.3, opacity: 0.7 },
                zenith: { show: true, stroke: "#aaa", width: 1.3, opacity: 0.7 }
            },
            horizon: { show: true, fill: "#000000", opacity: 0.5 },
            form: false, // Hide the default form controls
            location: true // Use current location
        });
    }

    refreshStarChartButton.addEventListener('click', updateStarChart);

    // Initial call for star chart
    updateStarChart();
});
    </script>
</body>
</html>
